name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Grant Execute Permission for Gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build
      
    - name: Get Version from Tag
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(date +'%Y%m%d-%H%M%S')"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
      
    - name: Rename JAR File
      run: |
        cd build/libs
        JAR_FILE=$(ls *.jar | grep -v sources | grep -v javadoc | head -1)
        if [ -f "$JAR_FILE" ]; then
          mv "$JAR_FILE" "wolf-armor-and-storage-legacy-${{ steps.get_version.outputs.VERSION }}.jar"
          echo "Renamed to: wolf-armor-and-storage-legacy-${{ steps.get_version.outputs.VERSION }}.jar"
        fi
      
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/libs/wolf-armor-and-storage-legacy-${{ steps.get_version.outputs.VERSION }}.jar
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## Wolf Armor and Storage Legacy - Release ${{ steps.get_version.outputs.VERSION }}
          
          ### üê∫ Features
          - Wolf Armor System (Leather, Iron, Gold, Diamond)
          - Wolf Chest Storage (14 slots)
          - Auto-Heal AI - Wolves eat food from inventory when injured
          - Moon Howling - Wolves howl at full moon during midnight
          - Custom 3D models for armor and chest rendering
          - Armor damage reduction system
          
          ### üì¶ Installation
          1. Install NeoForge 1.21.10 for Minecraft
          2. Download the JAR file below
          3. Place it in your `mods` folder
          4. Launch Minecraft
          
          ### ‚öôÔ∏è Requirements
          - Minecraft 1.21.10
          - NeoForge 21.10.47-beta or later
          - Java 21+
          
          ### üìù Changelog
          See the full changelog in the README.md
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Artifact (Manual Build)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: wolf-armor-and-storage-legacy-${{ steps.get_version.outputs.VERSION }}
        path: build/libs/wolf-armor-and-storage-legacy-${{ steps.get_version.outputs.VERSION }}.jar
        retention-days: 30
